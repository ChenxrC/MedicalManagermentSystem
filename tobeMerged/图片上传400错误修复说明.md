# 图片上传400错误修复说明

## 🎯 问题描述

用户报告图片上传时出现400错误：
```
Bad Request: /api/exams/questions/upload_image/
[23/Aug/2025 21:34:25] "POST /api/exams/questions/upload_image/ HTTP/1.1" 400 36
```

## 🔍 问题分析

### 1. **API端点可访问**
- 从404错误变为400错误，说明API端点已经可以正常访问
- 问题在于请求参数或文件上传配置

### 2. **后端错误检查**
后端代码中的第一个检查：
```python
if 'image' not in request.FILES:
    return Response({'error': '没有找到图片文件'}, status=400)
```

这说明前端发送的请求中没有包含名为 `image` 的文件字段。

## ✨ 解决方案

### 1. **添加name属性**

**修改前：**
```vue
<el-upload
  :action="`${baseURL}/api/exams/questions/upload_image/`"
  :headers="uploadHeaders"
  :show-file-list="false"
  :on-success="handleImageSuccess"
  :on-error="handleImageError"
  :before-upload="beforeImageUpload"
  accept="image/*"
  class="image-upload"
>
```

**修改后：**
```vue
<el-upload
  :action="`${baseURL}/api/exams/questions/upload_image/`"
  :headers="uploadHeaders"
  :show-file-list="false"
  :on-success="handleImageSuccess"
  :on-error="handleImageError"
  :before-upload="beforeImageUpload"
  accept="image/*"
  name="image"
  class="image-upload"
>
```

### 2. **改进错误处理**

**修改前：**
```javascript
const handleImageError = (error) => {
  console.error('图片上传失败:', error)
  ElMessage.error('图片上传失败，请重试')
}
```

**修改后：**
```javascript
const handleImageError = (error, file, fileList) => {
  console.error('图片上传失败:', error)
  console.error('错误详情:', error.response?.data)
  console.error('文件信息:', file)
  
  let errorMessage = '图片上传失败，请重试'
  if (error.response?.data?.error) {
    errorMessage = `图片上传失败: ${error.response.data.error}`
  }
  
  ElMessage.error(errorMessage)
}
```

## 🔧 技术原理

### 1. **Element Plus el-upload组件**
- `name` 属性指定上传文件的字段名
- 默认字段名是 `file`，但后端期望的是 `image`
- 添加 `name="image"` 确保文件以正确的字段名发送

### 2. **文件上传流程**
1. 用户选择文件
2. `beforeImageUpload` 验证文件
3. el-upload组件以 `multipart/form-data` 格式发送文件
4. 文件字段名为 `image`（通过name属性指定）
5. 后端接收并处理文件

### 3. **错误处理改进**
- 添加更详细的错误日志
- 显示后端返回的具体错误信息
- 帮助调试和问题定位

## 🧪 测试验证

### 1. **使用调试脚本**
```bash
python test_upload_debug.py
```

### 2. **前端功能测试**
1. 启动Django服务器
2. 启动前端服务
3. 访问 `http://localhost:8080/exam-editor`
4. 创建试卷并添加问题
5. 尝试上传图片
6. 检查浏览器控制台的错误信息

### 3. **验证要点**
- ✅ 文件选择正常
- ✅ 文件验证通过
- ✅ 上传请求发送
- ✅ 后端接收文件
- ✅ 文件保存成功
- ✅ 返回图片URL

## 📋 常见问题排查

### 1. **仍然出现400错误**
- 检查浏览器网络面板，确认请求包含文件
- 检查后端日志，查看具体错误信息
- 验证文件类型和大小是否符合要求

### 2. **文件上传成功但无法显示**
- 检查媒体文件配置
- 验证图片URL是否正确
- 确认文件权限设置

### 3. **CORS错误**
- 检查Django CORS配置
- 确认前端和后端域名设置

## 🎉 修复结果

修复后，图片上传功能将正常工作：
- ✅ 正确的文件字段名
- ✅ 详细的错误信息
- ✅ 完整的文件上传流程
- ✅ 图片预览功能

现在可以正常使用图片上传功能了！
