# 图片功能数据库迁移指南

## 🎯 问题描述

当添加图片上传功能后，出现了数据库错误：`no such column: exams_question.image`

这是因为我们在模型中添加了新的`image`字段，但数据库中还没有相应的列。

## ✨ 解决方案

### 方法一：使用PowerShell命令（推荐）

1. **激活虚拟环境并应用迁移**：
   ```powershell
   cd backend
   .\venv\Scripts\Activate.ps1
   python manage.py migrate exams
   ```

2. **验证迁移状态**：
   ```powershell
   python manage.py showmigrations exams
   ```

### 方法二：使用Python脚本

如果PowerShell命令有问题，可以使用提供的Python脚本：

```powershell
python apply_migrations.py
```

### 方法三：手动SQL（高级用户）

如果其他方法都不行，可以手动添加数据库列：

```sql
ALTER TABLE exams_question ADD COLUMN image VARCHAR(100) NULL;
```

## 🔍 迁移文件详情

已创建的迁移文件：`backend/exams/migrations/0002_question_image_alter_question_question_type.py`

这个迁移包含：
- 添加 `image` 字段到 `Question` 模型
- 更新 `question_type` 字段的选择选项

## 📝 迁移后的功能

成功应用迁移后，您将获得以下新功能：

### 1. **题目图片上传**
- 支持 JPG、PNG、GIF、WebP 格式
- 最大文件大小：5MB
- 自动生成图片URL

### 2. **前端界面优化**
- 添加问题时可以上传图片
- 图片预览功能
- 问题列表中显示图片

### 3. **API端点**
- `POST /api/exams/questions/upload_image/` - 上传图片
- 图片字段集成到问题API中

## 🧪 测试步骤

1. **启动后端服务**：
   ```powershell
   cd backend
   .\venv\Scripts\Activate.ps1
   python manage.py runserver
   ```

2. **启动前端服务**：
   ```powershell
   cd frontend
   npm run dev
   ```

3. **测试图片功能**：
   - 访问：`http://localhost:8080/exam-editor`
   - 创建新试卷
   - 添加问题时上传图片
   - 查看问题列表中的图片显示

## ⚠️ 常见问题

### 问题1：PowerShell执行策略错误
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### 问题2：虚拟环境无法激活
```powershell
python -m venv venv
.\venv\Scripts\Activate.ps1
pip install -r requirements.txt
```

### 问题3：迁移仍然失败
1. 检查数据库文件权限
2. 确保没有其他Django进程在运行
3. 尝试重置迁移（慎用）

## 🔄 回滚方案

如果需要回滚迁移：

```powershell
cd backend
.\venv\Scripts\Activate.ps1
python manage.py migrate exams 0001
```

## 📞 技术支持

如果遇到问题，请检查：
1. Django版本：4.2.23
2. Python版本：3.9+
3. Pillow库是否已安装
4. 数据库文件是否可写

迁移成功后，图片上传功能将完全可用！
